---
title: "Practicum 3"
author: "Allison Hacker, Max Diamond, Isabelle Radis"
date: "5/26/2020"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load, include=FALSE, warning=FALSE}
library(DeclareDesign)
library(truncnorm) #for truncated distribution
library(knitr)
library(ggplot2)
library(kableExtra)
library(future.apply)
library(tidyverse)
library(effsize)

```

## Descriptives and outcomes

• Population size = 1000

• Initial sample size = 500 (Treatment = 375, Control = 125)

• Final sample size = 360 (Treatment = 375, Control = 125)

• baseline yield (tons/hectare) is random uniform [0.38, 8.21]

• estimated rate of change (not absolute change) from baseline yield = 0.8 +/- 0.4 (sd)

• treatment effect = 0.15

• estimators: difference-in-means and difference-in-differences

### Declare population
```{r population, echo=TRUE}
set.seed(228)
population <- declare_population(
  villages = add_level(N=1000, 
    yield=rnorm(n=N, mean=1.75, sd = 0.6),
    u=rnorm(n=N, mean=0.8, sd=0.4))
)
```

### Population descriptives
```{r population-see, echo=TRUE, fig.height=5.5}
pop <- population()
hist(pop[,2], xlab="Baseline Rice Yield (t/ha)", 
     main="Baseline", cex=24)
```

### Declare potential outcomes
```{r po, echo=TRUE}
potential_outcomes <- 
  declare_potential_outcomes(
    Y_D_0=yield + u,
    Y_D_1=yield + u + 0.15)
```

### Potential outcomes descriptives
```{r po-see, echo=TRUE}
po <- potential_outcomes(pop)
kable(po[1:5,], digits=1)
```

### Declare sampling
```{r sample, echo=TRUE}
sampling <- declare_sampling(n=500)
sam <- sampling(po)
kable(sam[1:5,c(1:2,4:6)], row.names = FALSE, digits = 1)
```

### Declare Assignment
```{r assign, echo=TRUE}
assigning <- declare_assignment(m = nrow(sam)*(3/4),
                  assignment_variable="D")
assigned <- assigning(sam)
kable(assigned[1:5,c(1:2,4:5,7:8)], digits = 1)
```


### Assessing balance
```{r violin, echo=FALSE, fig.height=6}
ggplot(data=assigned, aes(x=as.factor(D), y=yield)) +
geom_violin(aes(fill=as.factor(D), color=as.factor(D))) +
theme_minimal(base_size = 24) + xlab("Assignment")
```

### Declare reveal
```{r reveal, echo=TRUE}
revealing <- declare_reveal(assignment_variables=D)
```

### Declare estimand
```{r estimand, echo=TRUE}
estimand <- declare_estimand(ATE = 0.15)
estimand(po)
```

### Declare estimator
```{r estimator, echo=TRUE}
dim <- declare_estimator(Y ~ D, estimand = estimand,  
          model =  difference_in_means, label = "DIM")

did <- declare_estimator(Y - yield ~ D, 
                         estimand = estimand,  
          model =  difference_in_means, label = "DID")
```


### Declare design
```{r design, echo=TRUE}
design <- population + potential_outcomes + sampling +
          assigning + revealing + estimand + dim + did
```

### Diagnose design
```{r diagnosis, cache=TRUE}
diagnosis <- diagnose_design(design, sims=1000)

kable1 <- diagnosis$diagnosands_df[,c(1,3,5,9,11)] %>%
  kable() %>% 
   kable_styling(bootstrap_options = c("striped", "hover"))

save_kable(kable1, "kable_500.jpeg")


```

### Changing sample size
```{r sample2, echo=TRUE}
sampling2 <- declare_sampling(n=360)
sam2 <- sampling2(po)

assigning2 <- declare_assignment(m = nrow(sam2)*(3/4),
                  assignment_variable="D")

dim <- declare_estimator(Y ~ D, estimand = estimand,  
          model =  difference_in_means, label = "DIM")

did <- declare_estimator(Y - yield ~ D, estimand = estimand,  
          model =  difference_in_means, label = "DID")

design2 <- population + potential_outcomes + sampling2 +
          assigning2 + revealing + estimand + dim + did

diagnosis2 <- diagnose_design(design2, sims=1000)

kable2 <- diagnosis2$diagnosands_df[,c(1,3,5,9,11)] %>%
  kable() %>% 
   kable_styling(bootstrap_options = c("striped", "hover"))

save_kable(kable2, "kable_360.jpeg")
```

### Variance
```{r, echo=FALSE}
### variance of outcomes
var(po$Y_D_1)
mean(po$Y_D_1)
sd(po$Y_D_1)

```

### Test statistic
```{r, echo=FALSE}
outcomes <- assigned %>%
  mutate(dif = Y_D_1 - yield) %>% 
  select(villages, dif, D)

outcomes_aov <- aov(dif ~ D, data = outcomes)
summary(outcomes_aov)
cohen.d(sam$yield, sam$Y_D_1, paired = TRUE)

po2 <- po %>%
  select(villages, Y_D_0, Y_D_1) %>% 
  mutate(dif = Y_D_1 - Y_D_0)
  pivot_longer(cols = starts_with("Y_D"), names_to = "treatment",values_to="outcome") 

```

### What is the smallest treatment effect you can detect with sample size of 400
```{r effsize, echo=TRUE}

potential_outcomes2 <- 
  declare_potential_outcomes(
    Y_D_0= yield + u,
    Y_D_1= yield + u - 0.165)

po <- potential_outcomes2(pop)

sampling3 <- declare_sampling(n=400)
sam3 <- sampling3(po)

assigning3 <- declare_assignment(m = nrow(sam3)*(3/4),
                  assignment_variable="D")

dim <- declare_estimator(Y ~ D, estimand = estimand,  
          model =  difference_in_means, label = "DIM")

did <- declare_estimator(Y - yield ~ D, estimand = estimand,  
          model =  difference_in_means, label = "DID")

design3 <- population + potential_outcomes2 + sampling3 +
          assigning3 + revealing + estimand + dim + did

diagnosis <- diagnose_design(design3, sims=1000)
diagnosis$diagnosands_df[,c(1,3,5,9,11)] %>%
  kable()
```